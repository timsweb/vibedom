#!/bin/bash
set -e

echo "Starting vibedom VM..."

# Initialize git repository from workspace
if [ -d /mnt/workspace/.git ]; then
    echo "Cloning git repository from workspace..."
    git clone /mnt/workspace/.git /work/repo
    cd /work/repo

    # Checkout the same branch user is on
    CURRENT_BRANCH=$(git -C /mnt/workspace rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")
    echo "Detected branch: $CURRENT_BRANCH"

    # Checkout branch (create if doesn't exist locally)
    if git show-ref --verify --quiet refs/heads/"$CURRENT_BRANCH"; then
        git checkout "$CURRENT_BRANCH"
    else
        git checkout -b "$CURRENT_BRANCH"
    fi

    echo "Working on branch: $CURRENT_BRANCH"
else
    echo "Non-git workspace, initializing fresh repository..."
    mkdir -p /work/repo
    rsync -a --exclude='.git' /mnt/workspace/ /work/repo/ || true
    cd /work/repo
    git init
    
    # Set git identity for agent commits
    git config user.name "Vibedom Agent"
    git config user.email "agent@vibedom.local"
    
    git add .
    git commit -m "Initial snapshot from vibedom session" || echo "No files to commit"
fi

# Set git identity for agent commits (for git workspaces)
git config user.name "Vibedom Agent"
git config user.email "agent@vibedom.local"

echo "Git repository initialized at /work/repo"

# Restore Claude config from persistent volume
# Claude Code writes to /root/.claude.json via atomic rename, which breaks symlinks.
# Instead of fighting that, we copy the file in on startup and periodically sync it back.
CLAUDE_CONFIG=/root/.claude.json
CLAUDE_CONFIG_PERSIST=/root/.claude/.claude.json.persist
if [ -f "$CLAUDE_CONFIG_PERSIST" ]; then
    cp "$CLAUDE_CONFIG_PERSIST" "$CLAUDE_CONFIG"
    echo "Restored Claude config from persistent storage"
else
    echo "No previous Claude config found (first run)"
fi

# Start SSH agent with deploy key
if [ -f /mnt/config/id_ed25519_vibedom ]; then
    eval $(ssh-agent -s)
    ssh-add /mnt/config/id_ed25519_vibedom 2>/dev/null || true
fi

# Proxy environment variables are set by container runtime (-e flags)
# and are available to all processes including docker exec sessions
echo "Configuring explicit proxy mode..."
echo "Proxy: HTTP_PROXY=$HTTP_PROXY"

# Install vibedom proxy CA certificate (generated by host-side mitmproxy)
echo "Installing vibedom CA certificate..."
CA_CERT=/mnt/config/mitmproxy/mitmproxy-ca-cert.pem
if [ -f "$CA_CERT" ]; then
    mkdir -p /usr/local/share/ca-certificates
    cp "$CA_CERT" /usr/local/share/ca-certificates/vibedom-ca.crt
    update-ca-certificates 2>/dev/null || true
    export REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
    export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
    export CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
    export NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt
    echo "CA certificate installed"
else
    echo "Warning: CA cert not found at $CA_CERT"
fi

# Signal readiness
touch /tmp/.vm-ready

echo "VM ready!"

# Keep container running and periodically persist Claude config
sync_claude_config() {
    [ -f "$CLAUDE_CONFIG" ] && cp "$CLAUDE_CONFIG" "$CLAUDE_CONFIG_PERSIST" 2>/dev/null
}
trap 'sync_claude_config; exit 0' SIGTERM SIGINT

while true; do
    sync_claude_config
    sleep 30
done
